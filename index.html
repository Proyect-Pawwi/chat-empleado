<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Empleado</title>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#ece5dd;
}

/* Login */
.login-screen{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.login-screen h2{
  margin-bottom:15px;
}

.login-screen input{
  padding:12px;
  border-radius:20px;
  border:none;
  width:260px;
  margin-bottom:10px;
  text-align:center;
}

.login-screen button{
  padding:10px 25px;
  border:none;
  border-radius:20px;
  background:#ff7a00;
  color:white;
  cursor:pointer;
  font-weight:bold;
}

/* Chat */
.chat-screen{
  display:none;
  flex-direction:column;
  height:100vh;
}

.header{
  background:#ff7a00;
  color:white;
  padding:15px;
  font-weight:bold;
}

.chat-container{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
}

.message{
  max-width:65%;
  padding:10px 15px;
  margin:5px 0;
  border-radius:15px;
  font-size:14px;
  word-wrap:break-word;
}

.mine{
  background:#ff7a00;
  color:white;
  align-self:flex-end;
  border-bottom-right-radius:5px;
}

.other{
  background:white;
  align-self:flex-start;
  border-bottom-left-radius:5px;
}

.time{
  font-size:10px;
  margin-top:3px;
  text-align:right;
  opacity:0.7;
}

.input-area{
  display:flex;
  padding:10px;
  background:#f0f0f0;
}

.input-area input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:none;
  outline:none;
}

.input-area button{
  margin-left:10px;
  padding:10px 20px;
  border:none;
  border-radius:20px;
  background:#ff7a00;
  color:white;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <h2>Empleado - Ingresar Código de Chat</h2>
  <input type="text" id="chatCode" placeholder="Ej: 6993ecf71259c58416e04a6c">
  <button onclick="enterChat()">Entrar</button>
</div>

<!-- CHAT -->
<div class="chat-screen" id="chatScreen">
  <div class="header" id="chatHeader">Chat Empleado</div>

  <div class="chat-container" id="chat"></div>

  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Escribe un mensaje">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>

const API = "https://backendpawwi-production.up.railway.app";
let chatId = null;
let interval = null;
const EMPLOYEE_CODE = "EMP001"; // puedes hacerlo dinámico luego

function enterChat(){
  const code = document.getElementById("chatCode").value.trim();
  if(!code){
    alert("Ingresa un código válido");
    return;
  }

  chatId = code;

  document.getElementById("loginScreen").style.display="none";
  document.getElementById("chatScreen").style.display="flex";
  document.getElementById("chatHeader").textContent = "Chat Empleado - " + chatId;

  loadMessages();
  interval = setInterval(loadMessages,3000);
}

async function loadMessages(){
  if(!chatId) return;

  try{
    const res = await fetch(`${API}/api/messages/${chatId}`);
    if(!res.ok){
      console.error("Error GET:", res.status);
      return;
    }

    const messages = await res.json();
    const chat = document.getElementById("chat");
    chat.innerHTML = "";

    messages.forEach(msg=>{
      const div = document.createElement("div");
      div.classList.add("message");

      if(msg.senderCode === EMPLOYEE_CODE){
        div.classList.add("mine");
      } else {
        div.classList.add("other");
      }

      const fecha = new Date(msg.creadoEn);
      const hora = fecha.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      div.innerHTML = `
        <div><strong>${msg.senderCode}</strong></div>
        <div>${msg.texto}</div>
        <div class="time">${hora}</div>
      `;

      chat.appendChild(div);
    });

    chat.scrollTop = chat.scrollHeight;

  }catch(error){
    console.error("Error cargando mensajes:", error);
  }
}

async function sendMessage(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();

  if(!text || !chatId){
    alert("Mensaje vacío o chat no activo");
    return;
  }

  try{
    const res = await fetch(`${API}/api/messages/create`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        chatId: chatId,
        senderCode: EMPLOYEE_CODE,
        texto: text
      })
    });

    if(!res.ok){
      console.error("Error POST:", res.status);
      alert("Error enviando mensaje");
      return;
    }

    input.value="";
    loadMessages();

  }catch(error){
    console.error("Error enviando mensaje:", error);
  }
}

document.addEventListener("keydown",function(e){
  if(e.key === "Enter"){
    sendMessage();
  }
});

</script>

</body>
</html>
